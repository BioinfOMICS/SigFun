---
title: "Customized Analysis with SigFun"
package: SigFun
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 3
    number_sections: true
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{QuickStart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r style, echo=FALSE, results='asis'}
BiocStyle::markdown(css.files = c('custom.css'))
knitr::opts_chunk$set(collapse=TRUE, comment="#>")
```

# Introduction
While `SigFun` offers several built-in methods to correlate a signature with an 
expression profile, we recognize that users may have their own in-house or 
preferred analytical approaches. For instance, a user might want to utilize log2 
fold change as their primary metric, which is not a default correlation method 
in SigFun.

To accommodate this demand, `SigFun` provides a customizable pathway. Users can 
easily integrate their pre-computed results into the `SigFun` framework. The 
process is straightforward: simply create a dataframe named `cor.df` containing 
your custom gene-level statistics and add it to the metadata of the `SigFun` 
object. Once this is done, you can run the core `sig2Fun` function, which will 
leverage your user-provided data for all downstream functional analyses.

In default, `cor.df` is a data frame containing correlation statistics with 
two columns:
   - `gene`: GENE ID (default: ENSEMBL ID ex. ENSG00000156) must be matched with 
   the rowData in the object (or the mapping data as the following example).
   - `any column name`: Example, "log2FC" or "cor".


# Customized SigFun workflow: customize the `cor.df`.
The `sig2Fun` function offers the flexibility to use a custom, user-defined 
`cor.df` (correlation data frame) by including it within the input object's 
metadata.

When a `cor.df` is present in the input object, sig2Fun will directly utilize 
this pre-computed data for the analysis. This bypasses the default behavior of 
generating gene scores via the built-in `sigCor` function.

Therefore, users can supply their own analysis results by adding a `cor.df` to 
the input object prior to running the function. For instance, one could create a 
custom `cor.df` containing columns with desired metrics, such as:
**log2FC** or other_statistics

Users are free to define any column names, provided they are unique within the data frame.

This feature is crucial for subsequent analysis steps like Gene Set Enrichment 
Analysis (GGSEA). To perform GSEA on a custom metric, the user must specify the 
target column by setting the ranking.method argument accordingly. For example, 
to use the log2 fold change values for ranking, the argument would be set as 
**ranking.method="log2FC"**.

## Analyze Signature Functions with Customized Analysis Results.
**Build the S4 object**
```{r customized_log2FC, warning=FALSE, eval=FALSE}
library(SigFun)
library(dplyr)
data(demo_GSE181574)

#Loading an example SummarizedExperiment object.
#(you will replace them by your own data set)
SE_data <- SummarizedExperiment::SummarizedExperiment(
    assays=list(abundance=as.matrix(expr.data)),
    rowData=S4Vectors::DataFrame(mapping, row.names=mapping$ensg_id),
    colData=S4Vectors::DataFrame(SIG_MAT))

#Simulate log2 fold change values for each gene.
#(you will create it using your analysis result in the same format)
S4Vectors::metadata(SE_data)$cor.df <- data.frame(
    "gene"=mapping$ensg_id,
    "log2FC"=rnorm(nrow(mapping), mean = 0, sd = 2),
    "other_statistics"=rnorm(nrow(mapping), mean = 1, sd = 4)
)

#Check the cor.df format and make sure the ID system is matched with mapping.
S4Vectors::metadata(SE_data)$cor.df$gene |> head()
SummarizedExperiment::rowData(SE_data)$ensg_id |> head()
```

**Run SigFun with the Customized Analysis Result**
It is important to correctly set the ranking.method parameter. This parameter 
tells `sig2Fun` which column name in your custom `cor.df` dataframe to use for 
the GSEA analysis.
```{r sig2Fun_default, warning=FALSE, eval=FALSE}
# Run sig2Fun with the log2FC result.
GSE181574.sigfun.res <- sig2Fun(SE_data,
    ranking.method = "log2FC",  # Must matched with your column name in cor.df.
    t2g = t2g, # the ontology dataset
    strings=c("GOBP","GOCC","GOMF","KEGG", 
            "REACTOME","WP","HALLMARK","SIGNALING"))
```

```{r other_statistics, warning=FALSE, eval=FALSE}
# Of course, you can use other columns in cor.df by specifying "ranking.method".
GSE181574.sigfun.res <- sig2Fun(SE_data,
    ranking.method = "other_statistics",
    t2g = t2g, # the ontology dataset
    strings=c("GOBP","GOCC","GOMF","KEGG", 
            "REACTOME","WP","HALLMARK","SIGNALING"))

# view result summary 
show(GSE181574.sigfun.res)
```

# Session info
```{r sessionInfo, echo=FALSE}
sessionInfo()
```
