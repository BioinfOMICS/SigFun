---
title: "Step-by-step analysis in SigFun"
package: SigFun
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 3
    number_sections: true
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{QuickStart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r style, echo=FALSE, results='asis'}
BiocStyle::markdown(css.files = c('custom.css'))
knitr::opts_chunk$set(collapse=TRUE, comment="#>")
```

# Introduction
While SigFun is designed as a comprehensive framework, its individual functions 
can also be utilized in a standalone manner. To accommodate users who prefer 
this modular approach, **this section outlines the step-by-step procedure** for 
analyzing a signature by sequentially invoking specific functions.

# Step 1. Bridge the signature to the transcriptome data.
## Loading the demo input object and generate cor.df with sigCor.
The `sigCor` function is utilized to generate the cor.df dataset, which is 
subsequently stored within the object's metadata. In the context of this 
demonstration, the signature score is a binary variable. Consequently, logistic 
regression is employed for the analysis, which is invoked by setting the 
`cor.method` parameter to "logit".
```{r sigCor, warning=FALSE}
library(SigFun)
library(dplyr)

#Loading an example SummarizedExperiment object.
data(demo_GSE181574)

#(you will replace them by your own data set)
SE_data <- SummarizedExperiment::SummarizedExperiment(
    assays=list(abundance=as.matrix(expr.data)),
    rowData=S4Vectors::DataFrame(mapping, row.names=mapping$ensg_id),
    colData=S4Vectors::DataFrame(SIG_MAT))

#Generate the cor.df dataframe use the sigCor function or your analysis method.
#(see sigCor manual for more details)
SE_data.cor <- sigCor(SE_data=SE_data, cor.method="logit")
```


# Step 2. Run GSEA with SigFun.
## Take a glance of cor.df
In SE_data.cor and we can see there is two columns 
    * cor: the statistics of analysis result. 
    * pval: the significance value (p-value of the analysis).
```{r cor.df, warning=FALSE}
S4Vectors::metadata(SE_data.cor)$cor.df %>% head()
```

## Run GSEA analysis
Here we will use the column “cor” to run GSEA analysis powered by 
`clusterProfiler`.

```{r GSEA, warning=FALSE}
# Run GSEA using clusterProfiler
geneList <- SE_data.cor@metadata$cor.df["cor"] %>% unlist()
names(geneList) <- SE_data.cor@metadata$cor.df$gene
geneList <- sort(geneList, decreasing = TRUE)
clusterProfiler <- clusterProfiler::GSEA(geneList, TERM2GENE = t2g)

# Add the GSEA result to the metadata of your object
S4Vectors::metadata(SE_data.cor) <- list(
    gseaResult=clusterProfiler,
    cor.df=S4Vectors::metadata(SE_data.cor)$cor.df)

# View the result summary: you will see gseaResult in the metadata
show(SE_data.cor)
```

# Step 3. Plot the Integrative Heatmap with SigFun.
To use `plot_heat` function, we have to transform the t2g dataframe to a list 
format first. Then we can use plot_heat to generate a integrative heatmap.
```{r plot, warning=FALSE}
# Transform t2g (data.frame) to a list form
pathway.name <- unique(t2g$gs_name)
pathways.all <- lapply(pathway.name, function(x){
    res <- t2g %>% dplyr::filter(gs_name==x) %>%
    dplyr::select(ensembl_gene) %>%
    dplyr::pull()
    return(res)
})
names(pathways.all) <- pathway.name
```

Several arguments is important to customized your visualization 
* topN: How many top functions you would like to show (defulr: 10). 
* ranking.method: Ranking metric used in GSEA. It Should be appeared in the 
cor.df (default: “cor”) 
* significant_type: Significance metric for filtering. Values larger than 0.05 
will be omitted. It Should be appeared in the cor.df (default: “pval”) 
* strings: Pathway categories to visualize. (e.g. “HALLMARK”, “KEGG”)

```{r plot_heat, warning=FALSE}
# Use plot_heat to generate a integrative heatmap
HALLMARK.plot <- plot_heat(
    SE_data.fgsea=SE_data.cor,
    pathways.all=pathways.all,
    significant_type="pval", # the column name in cor.df
    strings=c("HALLMARK"),
    topN=10, 
    ranking.method="cor")  # the column name in cor.df
```

Signaling pathways represent fundamental signal transduction mechanisms that 
govern a wide range of cellular activities. To facilitate the targeted analysis 
of such processes, SigFun provides a powerful string-matching feature.

For instance, to specifically investigate all functions related to signal 
transduction, a user can filter the results by specifying the parameter 
strings=c(“SIGNALING”). This command instructs the function to isolate and 
display only those entries containing the “SIGNALING” pattern within the 
integrative heatmap, enabling a focused visualization of relevant pathways.

```{r singlaing, warning=FALSE}
# Use plot_heat to generate a integrative heatmap
SIGNALING.plot <- plot_heat(
    SE_data.fgsea=SE_data.cor,
    pathways.all=pathways.all,
    significant_type="pval", # the column name in cor.df
    strings=c("SIGNALING"),
    topN=10, 
    ranking.method="cor")  # the column name in cor.df
```

# Session info
```{r sessionInfo, echo=FALSE}
sessionInfo()
```
